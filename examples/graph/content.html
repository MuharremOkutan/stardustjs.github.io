<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        body {
            margin: 0; padding: 0;
        }
        #main-canvas {
            margin: 0; padding: 0;
        }
    </style>
</head>

<body>
    <canvas id="main-canvas"></canvas>

    <script src="//d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="//stardust-vis.github.io/stardust/stardust.bundle.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var canvas = document.getElementById("main-canvas");
        var width = 960;
        var height = 500;
        var platform = Stardust.platform("webgl-2d", canvas, width, height);

        var snodes = Stardust.shape.create(Stardust.shape.circle(8), platform);
        var snodesSelected = Stardust.shape.create(Stardust.shape.circle(8), platform);
        var sedges = Stardust.shape.create(Stardust.shape.line(), platform);

        d3.json("facebook_1912.json", (err, data) => {
            var nodes = data.nodes;
            var edges = data.edges;
            var N = nodes.length;

            for(var i = 0; i < N; i++) {
                nodes[i].x = Math.random() * width;
                nodes[i].y = Math.random() * height;
            }

            snodes
                .attr("center", (d) => [ d.x, d.y ])
                .attr("radius", 3)
                .attr("color", [ 55/255, 126/255, 184/255, 1 ]);

            snodesSelected
                .attr("center", (d) => [ d.x, d.y ])
                .attr("radius", 4)
                .attr("color", [ 228/255, 26/255, 28/255, 1 ]);

            sedges
                .attr("p1", (d) => [ d.source.x, d.source.y ])
                .attr("p2", (d) => [ d.target.x, d.target.y ])
                .attr("color", [ 93/255, 157/255, 218/255, 0.06 ]);

            var force = d3.layout.force()
                .size([ width, height ])
                .nodes(nodes)
                .links(edges);

            force.linkStrength(0.05);
            force.gravity(0.2);
            force.linkDistance(100);
            force.start();

            force.on("tick", () => {
                snodes.data(nodes);
                sedges.data(edges);
                requestRender();
            });

            let selectedNode = null;

            function requestRender() {
                requestAnimationFrame(render);
            }

            function render() {
                snodesSelected.data(selectedNode ? [ selectedNode ] : []);

                // Cleanup and re-render.
                platform.clear([ 1, 1, 1, 1 ]);
                sedges.render();
                snodes
                    .attr("radius", 3)
                    .attr("color", [ 1, 1, 1, 0.5 ]);
                snodes.render();
                snodes
                    .attr("radius", 2)
                    .attr("color", [ 55/255, 126/255, 184/255, 1 ]);
                snodes.render();

                snodesSelected.render();

                // Render the picking buffer.
                platform.beginPicking(canvas.width, canvas.height);
                snodes.attr("radius", 6); // make radius larger so it's easier to select.
                snodes.render();
                platform.endPicking();
            }

            // Handle dragging.
            canvas.onmousedown = function(e) {
                var x = e.clientX - canvas.getBoundingClientRect().left;
                var y = e.clientY - canvas.getBoundingClientRect().top;
                var p = platform.getPickingPixel(x * 2, y * 2);
                if(p) {
                    selectedNode = nodes[p[1]];
                    requestRender();
                    var onMove = function(e) {
                        var nx = e.clientX - canvas.getBoundingClientRect().left;
                        var ny = e.clientY - canvas.getBoundingClientRect().top;
                        nodes[p[1]].x = nx;
                        nodes[p[1]].y = ny;
                        if(force.alpha() == 0) force.resume();
                        requestRender();
                    };
                    var onUp = function() {
                        window.removeEventListener("mousemove", onMove);
                        window.removeEventListener("mouseup", onUp);
                        selectedNode = null;
                    };
                    window.addEventListener("mousemove", onMove);
                    window.addEventListener("mouseup", onUp);
                }
            };

            canvas.onmousemove = function(e) {
                var x = e.clientX - canvas.getBoundingClientRect().left;
                var y = e.clientY - canvas.getBoundingClientRect().top;
                var p = platform.getPickingPixel(x * 2, y * 2);
                if(p) {
                    if(selectedNode != nodes[p[1]]) {
                        selectedNode = nodes[p[1]];
                        requestRender();
                    }
                } else {
                    if(selectedNode != null) {
                        selectedNode = null;
                        requestRender();
                    }
                }
            }
        });
    </script>
</body>

</html>