<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="//stardust-vis.github.io/examples/assets/style.css" type="text/css" />
<style type="text/css">
    .fps { position: fixed; top: 0; right: 0; padding: 10px; margin: 0; font-size: 15px; }
</style>
<canvas id="main-canvas"></canvas>
<div class="fps"></div>
<div class="initializing"><p>Initializing...</p></div>
<script src="//d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script src="//stardust-vis.github.io/stardust/stardust.bundle.js" type="text/javascript"></script>
<script src="//stardust-vis.github.io/examples/assets/utils.js" type="text/javascript"></script>
<script type="text/javascript">
    var canvas = document.getElementById("main-canvas");
    var width = 960;
    var height = 500;
    var platform = Stardust.platform("webgl-2d", canvas, width, height);

    var snodes = Stardust.mark.create(Stardust.mark.circle(8), platform);
    var snodesSelected = Stardust.mark.create(Stardust.mark.circle(8), platform);
    var sedges = Stardust.mark.create(Stardust.mark.line(), platform);

    loadData("facebook_1912.json", (data) => {
        var nodes = data.nodes;
        var edges = data.edges;
        var N = nodes.length;

        for(var i = 0; i < N; i++) {
            nodes[i].index = i;
            nodes[i].x = Math.random() * width;
            nodes[i].y = Math.random() * height;
        }

        snodes
            .attr("center", (d) => [ d.x, d.y ])
            .attr("radius", 3)
            .attr("color", [ 55/255, 126/255, 184/255, 1 ]);

        snodesSelected
            .attr("center", (d) => [ d.x, d.y ])
            .attr("radius", 4)
            .attr("color", [ 228/255, 26/255, 28/255, 1 ]);

        sedges
            .attr("p1", (d) => [ d.source.x, d.source.y ])
            .attr("p2", (d) => [ d.target.x, d.target.y ])
            .attr("width", 1)
            .attr("color", [ 93/255, 157/255, 218/255, 0.06 ]);

        var force = d3.layout.force()
            .size([ width, height ])
            .nodes(nodes)
            .links(edges);

        force.linkStrength(0.05);
        force.gravity(0.2);
        force.linkDistance(60);
        force.start();

        var positions = Stardust.array("Vector2")
            .value(d => [ d.x, d.y ])
            .data(nodes);

        var positionScale = Stardust.scale.custom("array(pos, value)")
            .attr("pos", "Vector2Array", positions)
        snodes.attr("center", positionScale((d, i) => i));
        sedges.attr("p1", positionScale(d => d.source.index));
        sedges.attr("p2", positionScale(d => d.target.index));

        snodes.data(nodes);
        sedges.data(edges);

        force.on("tick", () => {
            force.alpha(0.1);
            positions.data(nodes);
            requestRender();
        });

        // Handle dragging

        let selectedNode = null;

        function requestRender() {
            requestAnimationFrame(render);
        }

        var fps = new FPS();

        function render() {
            snodesSelected.data(selectedNode ? [ selectedNode ] : []);

            // Cleanup and re-render.
            platform.clear([ 1, 1, 1, 1 ]);
            sedges.render();
            snodes
                .attr("radius", 3)
                .attr("color", [ 1, 1, 1, 0.5 ]);
            snodes.render();
            snodes
                .attr("radius", 2)
                .attr("color", [ 55/255, 126/255, 184/255, 1 ]);
            snodes.render();

            snodesSelected.render();

            // Render the picking buffer.
            platform.beginPicking(canvas.width, canvas.height);
            snodes.attr("radius", 6); // make radius larger so it's easier to select.
            snodes.render();
            platform.endPicking();

            fps.update();
        }

        var isDragging = false;
        // Handle dragging.
        canvas.onmousedown = function(e) {
            var x = e.clientX - canvas.getBoundingClientRect().left;
            var y = e.clientY - canvas.getBoundingClientRect().top;
            var p = platform.getPickingPixel(x * 2, y * 2);
            if(p) {
                selectedNode = nodes[p[1]];
                requestRender();
                isDragging = true;
                var onMove = function(e) {
                    var nx = e.clientX - canvas.getBoundingClientRect().left;
                    var ny = e.clientY - canvas.getBoundingClientRect().top;
                    nodes[p[1]].x = nx;
                    nodes[p[1]].y = ny;
                    // requestRender();
                };
                var onUp = function() {
                    window.removeEventListener("mousemove", onMove);
                    window.removeEventListener("mouseup", onUp);
                    selectedNode = null;
                    isDragging = false;
                };
                window.addEventListener("mousemove", onMove);
                window.addEventListener("mouseup", onUp);
            }
        };

        canvas.onmousemove = function(e) {
            if(isDragging) return;
            var x = e.clientX - canvas.getBoundingClientRect().left;
            var y = e.clientY - canvas.getBoundingClientRect().top;
            var p = platform.getPickingPixel(x * 2, y * 2);
            if(p) {
                if(selectedNode != nodes[p[1]]) {
                    selectedNode = nodes[p[1]];
                    requestRender();
                }
            } else {
                if(selectedNode != null) {
                    selectedNode = null;
                    requestRender();
                }
            }
        }
    });
</script>